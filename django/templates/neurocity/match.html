{% extends "neurocity/base.html" %}
{% load i18n %}

{% block content %}

<div align="left">

    <a class="btn btn-medium btn-primary btn-info" href="#" id='buttontoggle'>Toggle (T)</a>
  {% if not nc_matchonly %}
    <a class="btn btn-medium btn-primary btn-info" href="#" id='buttonskip'>Bad match (Space)</a>
    <a class="btn btn-medium btn-primary btn-info" href="#" id='buttongeturl'>Share link</a>
  {% endif %}
  <br /><br />
  <table>
    <tr id="origin_row"></tr>
    <tr id="target_row"></tr>
  </table>

  <!-- TODO: additional canvases with adjacent slices for more context -->
  <!-- <canvas id="c1" width="200" height="200" style="border:1px solid #aaa"></canvas> -->
  <!-- <canvas id="c4" width="200" height="200" style="border:1px solid #aaa"></canvas> -->

  <br />

  <h4><div id='segmentcost' /></h4>

</div>

<script type="text/javascript" src="{{ STATIC_URL }}libs/fabric.js/all.js"></script>
<script type="text/javascript">

    var get_url = function(tile_source_type, tile_base_url, zoom_level, sectionindex, yi, xi ) {
      if( tile_source_type === 1) {
        return tile_base_url+sectionindex+'/'+yi+'_'+xi+'_'+zoom_level+'.jpg';
      } else if( tile_source_type === 5 ) {
        return tile_base_url+'/'+zoom_level+'/'+sectionindex+'/'+yi+'/'+xi+'.jpg';
      }
    }

    var tile_base_url = "{{ tile_base_url|safe|escapejs }}",
        tile_source_type = eval("{{ tile_source_type|safe|escapejs }}"),
        zoom_level = eval("{{ zoom_level|safe|escapejs }}"),
        is_interactive = true;
        {% if nc_matchonly %}
        is_interactive = false;
        {% endif %}

    var border = 80, show_slices = true,
        radius = 300, origin_slices = [], target_slices = [],
        start, allslices = [];

    var segmentsequence = eval("{{ segmentsequence|safe|escapejs }}");

    var current_decision_index = 0;
    var current_decision = segmentsequence[ current_decision_index ];
    var origin_canvas;
    var target_canvases = [];

    // colorize slices
    // vote is one good, rest bad, or undefined when origin slice bad (?)

    var next_segment = function() {
      if( current_decision_index + 1 === segmentsequence.length ) {
        location.reload();
        return;
      }
      current_decision_index++;
      current_decision = segmentsequence[ current_decision_index ];

      reset_all();
      update_data( current_decision );
    }

    var reset_all = function() {
      // remove all canvas elements
      // remove all canvases from DOM
      // reinit variables
    }

    var vote_for_segment = function( canvas_index ) {
      var bad_segments = [], good_segment = 0;
      for(var idx=0; idx < current_decision['target_segments'].length; idx++) {
        if( idx == (canvas_index-2)) {
          good_segment = current_decision['target_segments'][idx]['primarykey'];
          continue;
        }
        bad_segments.push( current_decision['target_segments'][idx]['primarykey'] )
      }
      data = {
        'good_segment': good_segment,
        'bad_segments': bad_segments,
        'elapsed_time': new Date().getTime() - start

      }
      $.ajax({
        "dataType": 'json',
        "type": "POST",
        "cache": false,
        "url": 'vote',
        "data": data,
        "success": function(data) {
           next_segment();
        }
      });
    }

    var update_data = function( data ) {

           // compute tile dimensions
           tile_col_min = Math.floor( (data['totalbb']['min_x'] - border) / data['tile_width']);
           tile_col_max = Math.ceil( (data['totalbb']['max_x'] + border) / data['tile_width'] );
           tile_row_min = Math.floor( (data['totalbb']['min_y'] - border) / data['tile_height'] );
           tile_row_max = Math.ceil( (data['totalbb']['max_y'] + border) / data['tile_height'] );
           
           tile_left_offset = (data['totalbb']['min_x'] - border) - tile_col_min * data['tile_width'];
           tile_top_offset = (data['totalbb']['min_y'] - border) - tile_row_min * data['tile_height'];

            var vote_callback = function( event, canvas_index ) {
              return function( event ) {
                vote_for_segment( canvas_index );
              }
            }

           // create the origin canvas
           $('#origin_row').append('<td><canvas id="o1" style="border:0px solid #aaa;"></canvas></td>');
           origin_canvas = new fabric.Canvas('o1');
           origin_canvas.setWidth(data['totalbb']['width']+2*border);
           origin_canvas.setHeight(data['totalbb']['height']+2*border);
           origin_canvas.renderAll();
           origin_canvas.selection = false;
           if( is_interactive ) {
            origin_canvas.on('mouse:down', vote_callback( event, (idx+2) ));
           }
            
           var tile_canvas_callback = function (index, xi, yi) {
                return function(img) {
                    img.set({
                      left: -tile_left_offset + data['tile_width'] / 2. + data['tile_width'] * (xi - tile_col_min),
                      top: -tile_top_offset + data['tile_height'] / 2. + data['tile_height'] * (yi - tile_row_min),
                    });
                    img.hasControls = img.hasBorders = false;
                    img.lockMovementX = img.lockMovementY = true;
                    if( index == 1) // per convention the origin canvas has index 1
                      origin_canvas.add(img).sendToBack(img);
                    else
                      target_canvases[index-2].add(img).sendToBack(img);
                };
              }

           var additional_information = "";
           // create the target canvases for each segment
           for(var idx=0; idx < data['target_segments'].length; idx++) {
             if( !is_interactive ) {
               additional_information = "cost: " + data['target_segments'][idx]['cost'] +
                " / pkey: " + data['target_segments'][idx]['primarykey'] +
                " / type: " + data['target_segments'][idx]['segmenttype'];
             }
             $('#target_row').append('<td>'+additional_information+'<canvas id="t'+(idx+2)+'" style="border:0px solid #aaa"></canvas></td>');  
               target_canvas = new fabric.Canvas('t'+(idx+2));
               target_canvas.setWidth(data['totalbb']['width']+2*border);
               target_canvas.setHeight(data['totalbb']['height']+2*border);
               target_canvas.selection = false;
               if( is_interactive ) {
                target_canvas.on('mouse:down', vote_callback( event, (idx+2) ));
               }
               target_canvases.push( target_canvas )
            }

           // add tiles to canvases
           for(var xi = tile_col_min; xi < tile_col_max; xi++) {
            for(var yi = tile_row_min; yi < tile_row_max; yi++) {
              fabric.Image.fromURL( get_url( tile_source_type, 
                tile_base_url, 
                zoom_level, 
                data['origin_section'], 
                yi, 
                xi), tile_canvas_callback(1, xi, yi));
              // loop over all target canvase
              for(var idx=0; idx < data['target_segments'].length; idx++) {
                fabric.Image.fromURL( get_url( tile_source_type, 
                  tile_base_url, 
                  zoom_level, 
                  data['target_section'], 
                  yi, 
                  xi), tile_canvas_callback( (idx+2), xi, yi));
              }
            }
           }
           
           var slice_callback = function (index, slice_left_offset, slice_top_offset) {
                return function(img) {
                    img.set({
                      left: slice_left_offset,
                      top: slice_top_offset,
                    });
                    img.hasControls = img.hasBorders = false;
                    img.lockMovementX = img.lockMovementY = true;
                    img.opacity = 0.7;
                    if( index === 1)
                      origin_canvas.add(img).bringToFront(img);
                    else
                      target_canvases[index-2].add(img).bringToFront(img);
                    allslices.push( img );
                };
              };

           // add origin slices to canvas
           var slice_left_offset = data['origin_slice']['min_x'] - data['totalbb']['min_x'] + border + data['origin_slice']['width'] / 2. ,
              
               slice_top_offset = data['origin_slice']['min_y'] - data['totalbb']['min_y'] + border  + data['origin_slice']['height'] / 2.;

            fabric.Image.fromURL(data['origin_slice']['slicepath'], 
                slice_callback( 1, slice_left_offset, slice_top_offset ) );

           // add slices to canvas, need to be in the foreground
           for(var idx=0; idx < data['target_segments'].length; idx++) {
             for(var slice_idx=0; slice_idx < data['target_segments'][idx]['slice_ids'].length; slice_idx++) {
               var current_slice = data['target_segments'][idx]['slice_ids'][slice_idx];
               var slice_left_offset = current_slice['min_x'] - data['totalbb']['min_x'] + border + current_slice['width'] / 2. ,
                   slice_top_offset = current_slice['min_y'] - data['totalbb']['min_y'] + border  + current_slice['height'] / 2.;
                fabric.Image.fromURL(current_slice['slicepath'], 
                    slice_callback( idx+2, slice_left_offset, slice_top_offset ) );

             }
           }
    }

    var LoadData = function( index ) {
      if( index == segmentsequence.length ) {
        return;
      }
      // console.log('preload data in the background ...')
      // $.ajax({
      //   "dataType": 'json',
      //   "type": "GET",
      //   "cache": false,
      //   "url": 'segment-bb',
      //   "data": {
      //     'originsection': segmentsequence[ index ]['origin_section'],
      //     'targetsection': segmentsequence[ index ]['target_section'],
      //     'segmentid': segmentsequence[ index ]['id'],
      //   },
      //   "success": function(data) {
      //     segmentsequence[ index ]['data'] = data;
      //     index++;
      //     LoadData( index );
      //   }
      // });
    }

    // $.ajax({
    //   "dataType": 'json',
    //   "type": "GET",
    //   "cache": false,
    //   "url": 'segment-bb',
    //   "data": {
    //     'originsection': current_segment['origin_section'],
    //     'targetsection': current_segment['target_section'],
    //     'segmentid': current_segment['id'],
    //   },
    //   "success": function(data) {
    //     update_data( data );
    //     LoadData( 1 );
    //   }
    // });

    var render_all = function() {
      origin_canvas.renderAll();
      for(var idx = 0; idx < target_canvases.length; idx++) {
        target_canvases[ idx ].renderAll();
      }
    }

    var hide_slices_image = function() {
      for(var idx = 0; idx < allslices.length; idx++) {
        allslices[ idx ].setOpacity( 0.0 );
      }
      render_all();
    }

    var show_slices_image = function() {
      for(var idx = 0; idx < allslices.length; idx++) {
        allslices[ idx ].setOpacity( 0.7 );
      }
      render_all();
    }

    var vote = function( segmentkey, value, comment ) {
      var data = {
            segmentkey: segmentkey,
            vote: value,
          };
      
      if (comment !== undefined) {
        data['comment'] = comment;
      }

      data['elapsed_time'] = new Date().getTime() - start;

      $.ajax({
        "dataType": 'json',
        "type": "POST",
        "cache": false,
        "url": 'segment-vote',
        "data": data,
        "success": function(data) {
           // location.reload();
           next_segment();
        }
      });

    }

    var skip_segment = function() {
      // location.reload();
      vote_for_segment( 0 );
    }

    var toggle_slice = function() {
      if( show_slices ) {
        show_slices = false;
        hide_slices_image();
      } else {
        show_slices = true;
        show_slices_image();
      }
    }


    var register_keyevents = function() {
      $(document).on('keyup', function(e) { 

        {% if not nc_matchonly %}

          switch( e.keyCode ) {
            // case 65:
            //   vote( current_segment['id'], 1 );
            //   break;
            // case 83:
            //   vote( current_segment['id'], 2, get_comment() );
            //   break;
            case 39:
              location.reload();
              break;
            case 32:
              skip_segment();
              break;
          }

        {% endif %}
          if (e.keyCode == 84) {
            toggle_slice();
          }
      });      
    }

    $('#buttontoggle').on('click', function() {
      toggle_slice();
    });

    $('#buttonskip').on('click', function() {
      skip_segment();
    });

    $('#buttongeturl').on('click', function() {
      window.open( 'matchonly?sectionindex=' + current_decision['origin_section'] +
        '&slice_id=' + current_decision['origin_slice']['origin_slice_id'] )
    });

    register_keyevents();

    $(document).ready(function() {
      start = new Date().getTime();

      update_data( current_decision );

    });
  
</script>

{% endblock %}

